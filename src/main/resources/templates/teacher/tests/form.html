<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Создание тестов | Binario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 80px;
            background-color: #f8f9fa;
        }
        .navbar-binario {
            background-color: #4e73df !important;
            padding: 0.5rem 1rem !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        .navbar-binario .navbar-brand,
        .navbar-binario .nav-link {
            color: rgba(255,255,255,0.9) !important;
        }

        .navbar-binario .navbar-brand:hover,
        .navbar-binario .nav-link:hover {
            color: white !important;
        }

        .navbar-binario .navbar-toggler {
            border-color: rgba(255,255,255,0.5) !important;
        }
        .btn-primary {
            background-color: #4e73df;
            border: none;
        }
        .btn-primary:hover {
            background-color: #3a5ec0;
        }
    </style>
</head>

<body>
    <div th:insert="~{fragments/navbar :: navbar}"></div>

    <div class="container mt-4">
        <h2>Создание теста</h2>
        <form method="post" th:action="@{/teacher/sections/{sectionId}/tests(sectionId=${section.id})}" th:object="${test}" onsubmit="return convertAnswersToJson()">

            <div class="mb-3">
                <label class="form-label">Тип вопроса</label>
                <select class="form-select" id="questionType" name="questionType" onchange="toggleAnswerFields()">
                    <option value="SINGLE_CHOICE">Один верный</option>
                    <option value="MULTIPLE_CHOICE">Несколько верных</option>
                    <option value="TEXT_ANSWER">Текстовый ответ</option>
                    <option value="CODE_ANSWER">Ответ в коде</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Текст вопроса</label>
                <textarea class="form-control" name="questionText" rows="3"></textarea>
            </div>

            <!-- Для SINGLE_CHOICE и MULTIPLE_CHOICE -->
            <div class="mb-3 answer-options-block">
                <label class="form-label">Варианты ответов (по одному на строку)</label>
                <textarea class="form-control" id="simpleOptions" rows="5" placeholder="Привет\nПока\nКак дела"></textarea>
            </div>

            <div class="mb-3 answer-options-block">
                <label class="form-label">Номера правильных ответов (через запятую)</label>
                <input type="text" class="form-control" id="correctAnswers" placeholder="1,3">
            </div>

            <!-- Для TEXT_ANSWER -->
            <div class="mb-3" id="textAnswerBlock" style="display:none;">
                <label class="form-label">Правильный текстовый ответ</label>
                <textarea class="form-control" name="textAnswer" rows="3"></textarea>
            </div>

            <!-- Для CODE_ANSWER -->
            <div class="mb-3" id="codeAnswerBlock" style="display:none;">
                <label class="form-label">Правильный ответ в виде кода</label>
                <textarea class="form-control" name="codeAnswer" rows="5" placeholder="Например, код на JavaScript"></textarea>
            </div>

            <!-- Скрытые поля для JSON (для вариантов с выбором) -->
            <input type="hidden" name="rawAnswerOptions" id="rawAnswerOptions">
            <input type="hidden" name="rawChoiceAnswers" id="rawChoiceAnswers">

            <div class="mb-3">
                <label class="form-label">Максимальный балл</label>
                <input type="number" class="form-control" name="maxScore">
            </div>

            <div class="mb-3">
                <label class="form-label">Порядок сортировки</label>
                <input type="number" class="form-control" name="sortOrder">
            </div>

            <button type="submit" class="btn btn-primary">Создать</button>
        </form>
    </div>

    <script th:inline="none">
        function toggleAnswerFields() {
            const type = document.getElementById("questionType").value;
            const optionsBlocks = document.querySelectorAll(".answer-options-block");
            const textBlock = document.getElementById("textAnswerBlock");
            const codeBlock = document.getElementById("codeAnswerBlock");

            if (type === "SINGLE_CHOICE" || type === "MULTIPLE_CHOICE") {
                optionsBlocks.forEach(el => el.style.display = "block");
                textBlock.style.display = "none";
                codeBlock.style.display = "none";
            } else if (type === "TEXT_ANSWER") {
                optionsBlocks.forEach(el => el.style.display = "none");
                textBlock.style.display = "block";
                codeBlock.style.display = "none";
            } else if (type === "CODE_ANSWER") {
                optionsBlocks.forEach(el => el.style.display = "none");
                textBlock.style.display = "none";
                codeBlock.style.display = "block";
            }
        }

        document.addEventListener("DOMContentLoaded", toggleAnswerFields);

        function convertAnswersToJson() {
            const type = document.getElementById("questionType").value;

            if (type === "SINGLE_CHOICE" || type === "MULTIPLE_CHOICE") {
                const optionsText = document.getElementById("simpleOptions").value.trim().split("\n");
                const correctText = document.getElementById("correctAnswers").value.trim();

                const answerOptions = {};
                optionsText.forEach(function(text, index) {
                    answerOptions[(index + 1).toString()] = text;
                });

                const correctIndexes = correctText.split(",").map(function(i) { return i.trim(); }).filter(function(i) { return i !== ""; });

                const choiceAnswers = [{ correct: correctIndexes }];

                document.getElementById("rawAnswerOptions").value = JSON.stringify(answerOptions);
                document.getElementById("rawChoiceAnswers").value = JSON.stringify(choiceAnswers);
            } else {
                document.getElementById("rawAnswerOptions").value = "";
                document.getElementById("rawChoiceAnswers").value = "";
            }

            return true;
        }
    </script>
</body>

</html>